# 心理グラフのデータ欠損処理仕様

## 概要

心理グラフ（感情タイムライン）では、時間ごとの測定結果を表示しますが、測定していない時間帯や機器の不具合などによりデータが欠損する場合があります。本ドキュメントでは、データ欠損の処理方法と表示仕様について説明します。

## データ欠損の表現方法

### JSONデータでの表現
```json
{
  "timePoints": ["08:00", "08:30", "09:00", "09:30", "10:00"],
  "emotionScores": [30, 35, null, null, 40]
}
```

### 欠損値の種類
- **`null`**: 測定中断・機器停止
- **`undefined`**: データ未取得
- **`NaN`**: 計算エラー・無効値

## グラフ表示での処理

### Chart.js設定
```javascript
const chartOptions = {
  spanGaps: false, // nullの部分で線を途切れさせる
  plugins: {
    tooltip: {
      callbacks: {
        label: (context) => {
          if (context.parsed.y === null) {
            return 'データなし（測定中断）';
          }
          return `心理スコア: ${context.parsed.y}`;
        }
      }
    }
  }
};
```

### 視覚的表現
1. **線グラフ**: 欠損部分で線が途切れる
2. **ポイント**: 欠損部分では表示されない（透明）
3. **ツールチップ**: 「データなし（測定中断）」と表示

## データ品質評価

### 品質指標
- **良好**: 欠損率 < 10%
- **普通**: 欠損率 10-30%
- **不良**: 欠損率 > 30%

### 統計情報表示
```javascript
const dataStats = {
  totalPoints: 48,      // 全測定ポイント数
  validPoints: 35,      // 有効データ数
  missingPoints: 13,    // 欠損データ数
  missingPercentage: 27, // 欠損率（%）
  dataQuality: '普通'   // 品質評価
};
```

## テストケース

### 1. 通常のデータ欠損（2025-06-02）
- 断続的な欠損パターン
- 欠損率: 約25%
- 睡眠時間や休憩時間での測定中断を想定

### 2. 極端なデータ欠損（2025-06-03）
- 長期間の連続欠損
- 欠損率: 約85%
- 機器故障や長時間の測定停止を想定

## 実装上の注意点

### フロントエンド
1. `null`値の適切な処理
2. Chart.jsの`spanGaps: false`設定
3. ツールチップでの欠損表示
4. データ品質警告の表示

### バックエンド
1. JSONでの`null`値保持
2. 統計計算時の欠損値除外
3. データ品質メタデータの生成

### データ分析
1. 欠損率による信頼性評価
2. 連続欠損期間の特定
3. 測定パターンの分析

## 推奨される測定パターン

### 理想的な測定
- 30分間隔での連続測定
- 欠損率 < 10%
- 睡眠時間（23:00-07:00）以外は測定継続

### 許容範囲
- 1-2時間の測定中断は許容
- 欠損率 < 30%
- 主要な活動時間帯（08:00-22:00）での測定

### 改善が必要
- 欠損率 > 30%
- 4時間以上の連続欠損
- 重要な時間帯（食事時間、仕事時間）での欠損

## 今後の拡張予定

1. **補間機能**: 短期間の欠損に対する線形補間
2. **予測機能**: 過去のパターンからの欠損値推定
3. **アラート機能**: 測定中断の自動検知と通知
4. **品質レポート**: 週次・月次のデータ品質サマリー 